{% extends "base.html" %}

{% block title %}{{ document.id }} - ChromaDB Document Manager{% endblock %}

{% block content %}
<!-- Document Header -->
<div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-6">
    <div class="flex-1">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="/" class="hover:text-gray-700">Home</a></li>
                <li><i data-feather="chevron-right" class="w-4 h-4"></i></li>
                <li><a href="/documents" class="hover:text-gray-700">Documents</a></li>
                <li><i data-feather="chevron-right" class="w-4 h-4"></i></li>
                <li class="text-gray-900">{{ document.id }}</li>
            </ol>
        </nav>
        
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ document.id }}</h1>
        
        <div class="flex items-center space-x-4 text-sm text-gray-500">
            {% if document.created_at %}
            <span>Created: {{ document.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
            {% endif %}
            {% if document.updated_at %}
            <span>Updated: {{ document.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
            {% endif %}
        </div>
        
        {% if document.metadata %}
        <div class="flex items-center space-x-2 mt-3">
            {% if document.metadata.get('category') %}
            <span class="badge badge-secondary">{{ document.metadata.category }}</span>
            {% endif %}
            {% if document.metadata.get('author') %}
            <span class="badge badge-primary">{{ document.metadata.author }}</span>
            {% endif %}
            {% if document.metadata.get('tags') %}
                {% for tag in document.metadata.tags %}
                <span class="badge badge-secondary">{{ tag }}</span>
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <div class="mt-4 sm:mt-0 flex space-x-3">
        <button id="copy-id" class="btn btn-secondary">
            <i data-feather="copy" class="w-4 h-4 mr-2"></i>
            Copy ID
        </button>
        <button id="edit-document" class="btn btn-secondary">
            <i data-feather="edit" class="w-4 h-4 mr-2"></i>
            Edit
        </button>
        <button id="delete-document" class="btn btn-danger">
            <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
            Delete
        </button>
    </div>
</div>

<!-- Document Content -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Content</h2>
                <div class="flex space-x-2">
                    <button id="copy-content" class="text-gray-500 hover:text-gray-700" title="Copy content">
                        <i data-feather="copy" class="w-4 h-4"></i>
                    </button>
                    <button id="download-content" class="text-gray-500 hover:text-gray-700" title="Download as file">
                        <i data-feather="download" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <div class="prose max-w-none">
                <div id="document-content" class="whitespace-pre-wrap text-gray-700 leading-relaxed p-4 bg-gray-50 rounded-lg border">{{ document.content }}</div>
            </div>
            
            <div class="mt-4 text-sm text-gray-500">
                Character count: <span id="content-length">{{ document.content|length }}</span>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Metadata -->
        {% if document.metadata %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Metadata</h3>
            </div>
            
            <div class="space-y-3">
                {% for key, value in document.metadata.items() %}
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500 capitalize">{{ key.replace('_', ' ') }}</span>
                    <span class="text-sm text-gray-900">
                        {% if value is iterable and value is not string %}
                            {{ value|join(', ') }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Similar Documents -->
        {% if similar_documents %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Similar Documents</h3>
                <span class="text-sm text-gray-500">Based on content similarity</span>
            </div>
            
            <div class="space-y-3">
                {% for similar in similar_documents %}
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="text-sm font-medium text-gray-900 line-clamp-1">{{ similar.id }}</h4>
                        <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">
                            {{ (100 * (1 - similar.distance))|round }}% match
                        </span>
                    </div>
                    <p class="text-xs text-gray-600 line-clamp-2 mb-2">{{ similar.content[:100] }}...</p>
                    <div class="flex items-center justify-between">
                        {% if similar.metadata.get('category') %}
                        <span class="badge badge-secondary text-xs">{{ similar.metadata.category }}</span>
                        {% endif %}
                        <button onclick="window.location.href='/document/{{ similar.id }}'" 
                                class="text-xs text-blue-600 hover:text-blue-800">
                            View â†’
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Actions</h3>
            </div>
            
            <div class="space-y-2">
                <button id="find-similar" class="btn btn-secondary w-full justify-start">
                    <i data-feather="search" class="w-4 h-4 mr-2"></i>
                    Find Similar Documents
                </button>
                
                <button id="export-document" class="btn btn-secondary w-full justify-start">
                    <i data-feather="download" class="w-4 h-4 mr-2"></i>
                    Export Document
                </button>
                
                <button id="share-document" class="btn btn-secondary w-full justify-start">
                    <i data-feather="share" class="w-4 h-4 mr-2"></i>
                    Share Document
                </button>
            </div>
        </div>
    </div>
</div>

{% if error %}
<!-- Error Display -->
<div class="card border-red-200 bg-red-50 mt-8">
    <div class="flex items-center">
        <div class="flex-shrink-0">
            <i data-feather="alert-circle" class="w-5 h-5 text-red-500"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">Error</h3>
            <p class="text-sm text-red-700 mt-1">{{ error }}</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const documentId = '{{ document.id }}';
    const documentContent = {{ document.content|tojson }};
    
    // Copy document ID
    document.getElementById('copy-id').addEventListener('click', function() {
        copyToClipboard(documentId);
    });
    
    // Copy content
    document.getElementById('copy-content').addEventListener('click', function() {
        copyToClipboard(documentContent);
    });
    
    // Download content
    document.getElementById('download-content').addEventListener('click', function() {
        downloadAsFile(documentContent, `${documentId}.txt`, 'text/plain');
    });
    
    // Edit document
    document.getElementById('edit-document').addEventListener('click', function() {
        window.toastManager.info('Edit functionality would be implemented here');
    });
    
    // Delete document
    document.getElementById('delete-document').addEventListener('click', function() {
        window.modalManager.confirm(
            'Delete Document',
            `Are you sure you want to delete document "${documentId}"? This action cannot be undone.`,
            async function() {
                try {
                    await window.chromaAPI.deleteDocument(documentId);
                    window.toastManager.success('Document deleted successfully');
                    window.location.href = '/documents';
                } catch (error) {
                    window.toastManager.error('Failed to delete document: ' + error.message);
                }
            }
        );
    });
    
    // Find similar documents
    document.getElementById('find-similar').addEventListener('click', function() {
        const searchQuery = encodeURIComponent(documentContent.substring(0, 200));
        window.location.href = `/search?q=${searchQuery}`;
    });
    
    // Export document
    document.getElementById('export-document').addEventListener('click', function() {
        const exportData = {
            id: documentId,
            content: documentContent,
            metadata: {{ document.metadata|tojson }},
            created_at: '{{ document.created_at.isoformat() if document.created_at else "" }}',
            updated_at: '{{ document.updated_at.isoformat() if document.updated_at else "" }}'
        };
        
        downloadAsFile(
            JSON.stringify(exportData, null, 2), 
            `${documentId}.json`, 
            'application/json'
        );
    });
    
    // Share document
    document.getElementById('share-document').addEventListener('click', function() {
        const shareUrl = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: `Document: ${documentId}`,
                url: shareUrl
            });
        } else {
            copyToClipboard(shareUrl);
        }
    });
});
</script>
{% endblock %}